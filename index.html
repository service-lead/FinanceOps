<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Interactive Month-End Dashboard</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<style>
  :root{
    --bg:#000000;
    --panel:#1a1a1a;
    --panel-2:rgba(173,11,246,.08);
    --text:#ffffff;
    --muted:#a0a0a0;
    --accent:#AD0BF6; 
    --accent-2:#ff4d8d; 
    --danger:#e11d48;
    --good:#10b981;
    --warn:#f59e0b;
    --border:#333333;
    --chip:rgba(173,11,246,.1);
    --shadow: 0 8px 24px rgba(0,0,0,.3);
    --radius: 14px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    background:var(--bg);
    color:var(--text);
  }
  .container{max-width:1200px; margin:32px auto; padding:0 16px;}
  header{
    display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:16px;
  }
  
  .header-left{
    display:flex; align-items:center; gap:16px;
  }
  
  .header-logo{
    width:300px; height:100px; object-fit:contain;
  }
  
  .header-title{
    font-size:24px; margin:0; color:var(--text); font-weight:700;
  }
  .title{
    display:flex; align-items:center; gap:12px;
  }
  .title .logo{
    width:106px; height:106px; border-radius:10px; background:linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
    box-shadow: var(--shadow);
  }
  .title h1{font-size:20px; margin:0; letter-spacing:.2px}
  main{display:grid; gap:16px}
  .tab{display:block}
  .panel{ background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); }
  .panel-header{
    padding:14px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; gap:12px;
  }
  .panel-body{padding:16px}
  .kpis{
    display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:12px;
  }
  @media (max-width:900px){ .kpis{grid-template-columns:repeat(2,minmax(0,1fr));} }
  @media (max-width:560px){ .kpis{grid-template-columns:1fr;} }
  .kpi{ background: #AD0BF6; border:1px solid rgba(173,11,246,.2); border-radius:12px; padding:14px; display:flex; flex-direction:column; gap:8px; }
  .kpi .label{color:white; font-size:12px; text-transform:uppercase; letter-spacing:.6px}
  .kpi .value{font-size:22px; color: white; font-weight:800}
  .kpi .delta{font-size:12px; color:var(--muted)}
  .delta .up{color:white; font-weight:700}
  .delta .down{color:white; font-weight:700}
  .grid-2{
    display:grid; grid-template-columns: 1.2fr .8fr; gap:12px;
  }
  @media (max-width:900px){ .grid-2{grid-template-columns:1fr;} }
  canvas{width:100% !important; height:auto !important}
  .controls{
    display:flex; gap:8px; flex-wrap:wrap; align-items:center;
  }
  select, input[type="text"], textarea, button.icon, button.primary{ background:rgba(173,11,246,.08); border:1px solid rgba(173,11,246,.3); color:var(--text); padding:10px 12px; border-radius:10px; outline:none; }
  select, input[type="text"]{min-width:160px}
  button.icon{cursor:pointer}
  button.primary, a.primary{background: #AD0BF6; color:#ffffff; font-weight:800; border:0; text-decoration:none; padding:10px 14px; border-radius:10px; display:inline-flex; align-items:center; gap:8px}
  .analysis{ background:rgba(173,11,246,.05); border:1px dashed rgba(173,11,246,.4); border-radius:12px; padding:14px; line-height:1.6; color:var(--text); }
  .chips{display:flex; gap:8px; flex-wrap:wrap}
  .chip{ background:rgba(173,11,246,.1); color:var(--text); border:1px solid rgba(173,11,246,.3); border-radius:999px; padding:8px 12px; font-size:12px; cursor:pointer; }
  .layout{
    display:grid; grid-template-columns: 1.1fr .9fr; gap:12px;
  }
  @media (max-width:900px){ .layout{grid-template-columns:1fr;} }
  table{width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:12px;}
  thead th{ text-align:left; font-size:12px; color:var(--muted); padding:10px 12px; background:rgba(173,11,246,.08); border-bottom:1px solid var(--border); cursor:pointer; user-select:none; }
  tbody td{
    padding:10px 12px; border-bottom:1px solid var(--border);
  }
  tbody tr:hover{background:rgba(173,11,246,.05)}
  .searchbar{display:flex; gap:8px; flex-wrap:wrap}
  .searchbar input{flex:1; min-width:220px}
  .chatbox{ height:420px; overflow:auto; background:rgba(173,11,246,.05); border:1px solid rgba(173,11,246,.3); border-radius:12px; padding:12px; display:flex; flex-direction:column; gap:12px; }
  .msg{display:flex; gap:10px; align-items:flex-start}
  .msg .bubble{padding:10px 12px; border-radius:14px; max-width:78%;}
  .msg.user{justify-content:flex-end}
  .msg.user .bubble{background:linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%); color:#ffffff; border:0; align-self:flex-end}
  .msg.bot .bubble{background:rgba(173,11,246,.15); border:1px solid var(--accent)}
  .chat-input{display:flex; gap:8px}
  .chat-input textarea{flex:1; min-height:60px; max-height:220px; resize:vertical; line-height:1.5;}
  .muted{color:var(--muted)}
  .pulse{animation:pulse 1.2s ease 0s 2}
  @keyframes pulse{
    0%{box-shadow:0 0 0 0 rgba(173,11,246,.5)}
    70%{box-shadow:0 0 0 16px rgba(173,11,246,0)}
    100%{box-shadow:0 0 0 0 rgba(173,11,246,0)}
  }
  .logo img{ width:36px; height:36px; border-radius:10px; object-fit:cover; }
  .logo-placeholder{ width:36px; height:36px; background:linear-gradient(135deg, #AD0BF6 0%, #ff4d8d 100%); border-radius:10px; box-shadow:var(--shadow); }
  
  /* Tab Styles */
  .tab-btn {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--muted);
    padding: 10px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s ease;
  }
  .tab-btn:hover {
    background: rgba(173,11,246,.08);
    border-color: rgba(173,11,246,.3);
  }
  .tab-btn.active {
    background: #AD0BF6;
    color: white;
    border-color: #AD0BF6;
  }
  .tab-btn:first-child { border-top-right-radius: 0; border-bottom-right-radius: 0; }
  .tab-btn:not(:first-child):not(:last-child) { border-radius: 0; border-left: none; }
  .tab-btn:last-child { border-top-left-radius: 0; border-bottom-left-radius: 0; border-left: none; }
  
  /* Fixed Footer */
  footer {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 1000;
  }
  
  /* Adjust container for fixed footer */
  .container {
    padding-bottom: 80px;
  }
  
  /* Login Screen Styles */
  .login-container {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 20px;
  }
  
  .login-panel {
    background: black;
    border-radius: 16px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    padding: 40px;
    width: 100%;
    max-width: 400px;
    border: 1px solid rgba(173, 11, 246, 0.3);
  }
  
  .login-header {
    text-align: center;
    margin-bottom: 20px;
  }
  
  .login-header .logo {
    width: 300px;
    /* height: 300px; */
    margin: 0 auto 10px auto;
    display: block;
    object-fit: contain;
  }
  
  .login-header h1 {
    margin: 0 0 8px 0;
    color: var(--text);
    font-size: 24px;
    background: linear-gradient(135deg, #AD0BF6 0%, #4F46E5 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-weight: 700;
  }
  
  .form-group {
    margin-bottom: 20px;
  }
  
  .form-group label {
    display: block;
    margin-bottom: 8px;
    color: var(--text);
    font-weight: 500;
  }
  
  .form-group input {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid var(--border);
    border-radius: 8px;
    font-size: 16px;
    transition: border-color 0.2s ease;
    box-sizing: border-box;
    background: var(--bg);
  }
  
  .form-group input:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(173, 11, 246, 0.1);
  }
  
  .login-form button {
    width: 100%;
    padding: 14px;
    font-size: 16px;
    font-weight: 600;
    background: linear-gradient(135deg, #AD0BF6 0%, #4F46E5 100%);
    border: none;
    transition: all 0.3s ease;
  }
  
  .login-form button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(173, 11, 246, 0.3);
  }
  
  .error-message {
    background: #fee;
    color: #c53030;
    padding: 12px;
    border-radius: 8px;
    margin-top: 16px;
    text-align: center;
    border: 1px solid #feb2b2;
  }
  
  .login-footer {
    margin-top: 30px;
    text-align: center;
    padding-top: 20px;
    border-top: 1px solid var(--border);
  }
  
  .demo-creds {
    background: rgba(173, 11, 246, 0.08);
    border: 1px solid rgba(173, 11, 246, 0.3);
    padding: 12px;
    border-radius: 8px;
    margin-top: 8px;
    font-size: 14px;
    color: var(--text);
  }
  
  /* Session timeout warning */
  .session-warning {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #f59e0b;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1001;
    display: none;
  }
</style>
</head>
<body>
  <!-- Login Screen -->
  <div id="loginScreen" class="login-container">
    <div class="login-panel">
      <div class="login-header">
        <img src="0. Logo.png" alt="Opsteam Logo" class="logo">
        <p class="muted">Please sign in</p>
      </div>
      <div class="login-form">
        <div class="form-group">
          <label for="username">Username</label>
          <input type="text" id="username" placeholder="Enter username" />
        </div>
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" placeholder="Enter password" />
        </div>
        <button id="loginBtn" class="primary">Sign In</button>
        <div id="loginError" class="error-message" style="display: none;"></div>
      </div>
      <div class="login-footer">
        <p class="muted">Demo Credentials:</p>
        <p class="demo-creds">Username: <strong>admin</strong> | Password: <strong>finops2024</strong></p>
      </div>
    </div>
  </div>

  <!-- Main Dashboard (Hidden until authenticated) -->
  <div id="dashboardContainer" class="container" style="display: none;">
    <header>
      <div class="header-left">
        <img src="0. Logo.png" alt="Opsteam Logo" class="header-logo">
      </div>
      <div class="controls">
        <label class="muted">Month</label>
        <select id="monthSelect"></select>
        <button class="icon" id="prevMonth" title="Previous Month">◀</button>
        <button class="icon" id="nextMonth" title="Next Month">▶</button>
        <button id="openWorkflowBtn" class="primary" type="button" data-url="https://opsteamai.app.n8n.cloud/webhook/97a5bfda-16e3-4c25-8278-57f42e16a9a2">Data Refresh</button>
        <button id="logoutBtn" class="icon" title="Logout" style="margin-left: 8px;">🚪</button>
      </div>
    </header>

    <main>
      <!-- Tab Navigation -->
      <div class="panel" style="margin-bottom: 16px;">
        <div class="panel-body" style="padding: 12px 16px;">
          <div class="controls" style="gap: 0;">
            <button class="tab-btn active" data-tab="exec" onclick="switchTab('exec')">Executive Summary</button>
            <button class="tab-btn" data-tab="chat" onclick="switchTab('chat')">AI Chatbot</button>
            <button class="tab-btn" data-tab="detail" onclick="switchTab('detail')">Detail View</button>
          </div>
        </div>
      </div>

      <section id="tab-exec" class="tab" aria-labelledby="Executive Summary" style="display:block">
        <div class="panel">
          <div class="panel-header">
            <strong>Executive Summary</strong>
            <span class="muted">Financial overview and analysis</span>
          </div>
          <div class="panel-body">
            <div class="kpis" id="kpis">
  
            </div>

            <div class="grid-2" style="margin-top:12px">
              <div class="panel">
                <div class="panel-header">
                  <strong>Financial Performance Trend</strong>
                  <span class="muted" id="trendSubtitle"></span>
                </div>
                <div class="panel-body">
                  <canvas id="trendChart" height="200"></canvas>
                </div>
              </div>
              <div class="panel">
                <div class="panel-header">
                  <strong>Expense Breakdown (Selected Month)</strong>
                  <span class="muted" id="mixSubtitle"></span>
                </div>
                <div class="panel-body">
                  <canvas id="mixChart" height="200"></canvas>
                </div>
              </div>
            </div>

            <div class="panel" style="margin-top:12px">
              <div class="panel-header">
                <strong>Analysis</strong>
                <span class="muted">Executive summary narrative</span>
              </div>
              <div class="panel-body">
                <div id="analysisText" class="analysis"></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="tab-chat" class="tab" aria-labelledby="AI Chatbot" style="display:none">
        <div class="panel">
          <div class="panel-header">
            <strong>AI Chatbot</strong>
            <span class="muted">Ask questions about your financial data</span>
          </div>
          <div class="panel-body">
            <div class="panel" style="margin-bottom:12px">
              <div class="panel-header">
                <strong>Quick Questions</strong>
                <div class="chips">
                  <span class="chip q">What is trading income?</span>
                  <span class="chip q">Compare May to Jun</span>
                  <span class="chip q">Show top account</span>
                  <span class="chip q">Operating expenses</span>
                  <span class="chip q">Cost of sales</span>
                </div>
              </div>
            </div>
            <div class="chatbox" id="chatLog" aria-live="polite"></div>
            <div class="chat-input" style="margin-top:10px">
              <textarea id="chatInput" placeholder="Ask about revenue, profit, margin, growth, top account, compare months..."></textarea>
              <button class="primary" id="sendBtn">Ask</button>
            </div>
            <div class="muted" style="margin-top:8px; font-size:12px">
              Tip: Try "Set month to April", "Compare March vs May", "What's margin?", "Top section".
            </div>
          </div>
        </div>
      </section>

      <section id="tab-detail" class="tab" aria-labelledby="Detail" style="display:none">
        <div class="panel">
          <div class="panel-header">
            <div class="controls">
              <label class="muted">Month</label>
              <select id="detailMonthSelect"></select>
              <label class="muted">Section</label>
              <select id="sectionSelect"></select>
            </div>
            <div class="searchbar">
              <input type="text" id="searchInput" placeholder="Search account or section..." />
              <button class="primary" id="resetFilters">Reset</button>
            </div>
          </div>
          <div class="panel-body">
            <div class="layout">
              <div class="panel">
                <div class="panel-header"><strong>Accounts</strong><span class="muted" id="tableSubtitle"></span></div>
                <div class="panel-body" style="padding:0">
                  <table id="detailTable" aria-label="Detail Table">
                    <thead>
                      <tr>
                        <th data-sort="account">Account</th>
                        <th data-sort="section">Section</th>
                        <th data-sort="value">Value</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
              <div class="panel">
                <div class="panel-header"><strong>Value by Account</strong><span class="muted" id="barSubtitle"></span></div>
                <div class="panel-body">
                  <canvas id="barChart" height="240"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main> 
    <footer style="background: white; color: black; text-align: center; padding: 16px; margin-top: 32px; font-weight: 600;">
      Powered by OpsTeam
    </footer>
  </div>
  
  <!-- Session Timeout Warning -->
  <div id="sessionWarning" class="session-warning">
    Your session will expire in <span id="sessionCountdown">5:00</span>. Click to extend.
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script>

    // Authentication System
    const AUTH_CONFIG = {
      credentials: {
        admin: 'finops2024',
        user: 'demo123',
        manager: 'manager2024'
      },
      sessionTimeout: 30 * 60 * 1000, // 30 minutes
      warningTime: 5 * 60 * 1000 // 5 minutes warning
    };

    let currentUser = null;
    let sessionTimer = null;
    let warningTimer = null;
    let sessionStartTime = null;

    // Check if user is already authenticated
    function checkAuth() {
      const savedUser = localStorage.getItem('finops_user');
      const sessionStart = localStorage.getItem('finops_session_start');
      
      if (savedUser && sessionStart) {
        const sessionAge = Date.now() - parseInt(sessionStart);
        if (sessionAge < AUTH_CONFIG.sessionTimeout) {
          currentUser = savedUser;
          sessionStartTime = parseInt(sessionStart);
          showDashboard();
          startSessionTimer();
          return true;
        } else {
          // Session expired
          logout();
        }
      }
      return false;
    }

    // Login function
    function login(username, password) {
      if (AUTH_CONFIG.credentials[username] === password) {
        currentUser = username;
        sessionStartTime = Date.now();
        localStorage.setItem('finops_user', username);
        localStorage.setItem('finops_session_start', sessionStartTime.toString());
        showDashboard();
        startSessionTimer();
        // Initialize dashboard after successful login
        init();
        return true;
      }
      return false;
    }

    // Logout function
    function logout() {
      currentUser = null;
      sessionStartTime = null;
      localStorage.removeItem('finops_user');
      localStorage.removeItem('finops_session_start');
      clearSessionTimers();
      showLogin();
    }

    // Show dashboard
    function showDashboard() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('dashboardContainer').style.display = 'block';
    }

    // Show login
    function showLogin() {
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('dashboardContainer').style.display = 'none';
    }

    // Session management
    function startSessionTimer() {
      clearSessionTimers();
      
      sessionTimer = setTimeout(() => {
        logout();
        alert('Your session has expired. Please log in again.');
      }, AUTH_CONFIG.sessionTimeout);
      
      warningTimer = setTimeout(() => {
        showSessionWarning();
      }, AUTH_CONFIG.sessionTimeout - AUTH_CONFIG.warningTime);
    }

    function clearSessionTimers() {
      if (sessionTimer) clearTimeout(sessionTimer);
      if (warningTimer) clearTimeout(warningTimer);
    }

    function showSessionWarning() {
      const warning = document.getElementById('sessionWarning');
      const countdown = document.getElementById('sessionCountdown');
      warning.style.display = 'block';
      
      let timeLeft = Math.floor(AUTH_CONFIG.warningTime / 1000);
      const countdownInterval = setInterval(() => {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        countdown.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        timeLeft--;
        
        if (timeLeft < 0) {
          clearInterval(countdownInterval);
          warning.style.display = 'none';
        }
      }, 1000);
      
      warning.onclick = () => {
        clearInterval(countdownInterval);
        warning.style.display = 'none';
        startSessionTimer(); // Reset timers
      };
    }

    // Event listeners for authentication
    document.addEventListener('DOMContentLoaded', function() {
      // Check if already authenticated
      if (!checkAuth()) {
        showLogin();
      }
      
      // Login form handler
      document.getElementById('loginBtn').addEventListener('click', function() {
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        const errorDiv = document.getElementById('loginError');
        
        if (!username || !password) {
          errorDiv.textContent = 'Please enter both username and password';
          errorDiv.style.display = 'block';
          return;
        }
        
        if (login(username, password)) {
          errorDiv.style.display = 'none';
        } else {
          errorDiv.textContent = 'Invalid username or password';
          errorDiv.style.display = 'block';
        }
      });
      
      // Enter key support for login
      document.getElementById('password').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          document.getElementById('loginBtn').click();
        }
      });
      
      // Logout button
      document.getElementById('logoutBtn').addEventListener('click', function() {
        logout();
      });
      
      // Initialize dashboard only if authenticated
      if (currentUser) {
        init();
      }
    });

    const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

    let rows = [];

    function keyFrom(year, mNum){ return `${year}-${String(mNum).padStart(2,'0')}`; }
    function labelFrom(year, mNum){ return `${monthNames[mNum-1]} ${year}`; }

    function computeMonthSeries(data){
      const byKey = new Map();
      for(const r of data){
        const key = keyFrom(r.calendarYear, r.monthNum);
        const label = labelFrom(r.calendarYear, r.monthNum);
        const rec = byKey.get(key) || { key, label, tradingIncome:0, otherIncome:0, operatingExpenses:0, costOfSales:0 };
        
        // Categorize based on section and account names
        const section = (r.section || '').toLowerCase();
        const account = (r.account || '').toLowerCase();
        const value = Number(r.value) || 0;
        
        if (/trading.*income|sales.*income|revenue/i.test(section) || /trading.*income|sales.*income|revenue/i.test(account)) {
          rec.tradingIncome += value;
        } else if (/other.*income|misc.*income|interest.*income/i.test(section) || /other.*income|misc.*income|interest.*income/i.test(account)) {
          rec.otherIncome += value;
        } else if (/operating.*expense|admin.*expense|overhead/i.test(section) || /operating.*expense|admin.*expense|overhead/i.test(account)) {
          rec.operatingExpenses += value;
        } else if (/cost.*of.*sales|cogs|direct.*cost/i.test(section) || /cost.*of.*sales|cogs|direct.*cost/i.test(account)) {
          rec.costOfSales += value;
        } else {
          // Default categorization - positive values as income, negative as expenses
          if (value > 0) {
            rec.tradingIncome += value;
          } else {
            rec.operatingExpenses += Math.abs(value);
          }
        }
        
        byKey.set(key, rec);
      }
      const series = Array.from(byKey.values()).sort((a,b)=> a.key.localeCompare(b.key));
      return series.map(m => ({ 
        ...m, 
        totalIncome: m.tradingIncome + m.otherIncome,
        totalExpenses: m.operatingExpenses + m.costOfSales,
        profit: (m.tradingIncome + m.otherIncome) - (m.operatingExpenses + m.costOfSales),
        margin: (m.tradingIncome + m.otherIncome) > 0 ? ((m.tradingIncome + m.otherIncome) - (m.operatingExpenses + m.costOfSales)) / (m.tradingIncome + m.otherIncome) : 0 
      }));
    }

    let monthSeries = computeMonthSeries(rows);

    
    const fmt = new Intl.NumberFormat("en-US", { maximumFractionDigits: 0 });
    const fmt2 = new Intl.NumberFormat("en-US", { maximumFractionDigits: 2 });
    const currency = (v) => "$" + fmt.format(v);
    const percent = (v) => (v >= 0 ? "+" : "") + fmt2.format(v * 100) + "%";
    const findMonth = (key) => monthSeries.find(m => m.key === key);
    const indexOfMonth = (key) => monthSeries.findIndex(m => m.key === key);
    
    function parseAIResponse(aiResponse) {
      if (!aiResponse) return "No response received from AI workflow.";
      
      if (Array.isArray(aiResponse) && aiResponse.length > 0 && aiResponse[0].message && aiResponse[0].message.content) {
        return aiResponse[0].message.content;
      }

      if (aiResponse.response) return aiResponse.response;
      if (aiResponse.message) return aiResponse.message;
      if (aiResponse.text) return aiResponse.text;
      if (aiResponse.answer) return aiResponse.answer;
      if (aiResponse.content) return aiResponse.content;
      if (typeof aiResponse === 'string') return aiResponse;
      
      if (typeof aiResponse === 'object') {
        for (const key in aiResponse) {
          const value = aiResponse[key];
          if (value && typeof value === 'object' && value['']) {
            const messages = value[''];
            if (Array.isArray(messages) && messages.length > 0) {
              const firstMessage = messages[0];
              if (firstMessage.message && firstMessage.message.content) {
                return firstMessage.message.content;
              }
            }
          }
        }
        
        const possibleFields = ['response', 'message', 'text', 'answer', 'content', 'result', 'output'];
        for (const field of possibleFields) {
          if (aiResponse[field]) return aiResponse[field];
        }
        
        for (const key in aiResponse) {
          if (typeof aiResponse[key] === 'string' && aiResponse[key].trim()) {
            return aiResponse[key];
          }
        }
      }
      
      return JSON.stringify(aiResponse);
    }

    function buildAccountRows(monthKey){
      const [year, m] = monthKey.split('-').map(Number);
      const monthNum = m;
      const filtered = rows.filter(r => r.calendarYear === year && r.monthNum === monthNum);
      const byAcct = new Map();
      for(const r of filtered){
        const key = `${r.account}|${r.section}`;
        const rec = byAcct.get(key) || { account:r.account, section:r.section, value:0 };
        rec.value += Number(r.value)||0;
        byAcct.set(key, rec);
      }
      return Array.from(byAcct.values()).sort((a,b)=> b.value - a.value);
    }

    function sectionMixForMonth(monthKey){
      const [year, m] = monthKey.split('-').map(Number);
      const monthNum = m;
      const filtered = rows.filter(r => r.calendarYear === year && r.monthNum === monthNum);
      const totals = filtered.reduce((acc, r)=>{
        acc[r.section] = (acc[r.section]||0) + (Number(r.value)||0);
        return acc;
      }, {});
      const sections = Object.keys(totals);
      const sum = sections.reduce((s,k)=> s + Math.abs(totals[k]), 0) || 1;
      return sections.map(k => ({ key:k, value: totals[k], pct: Math.abs(totals[k]) / sum }));
    }

    
    let currentMonthKey = monthSeries.length ? monthSeries[monthSeries.length - 1].key : null; 
    let trendChart, mixChart, barChart;
    let showProfitLine = true;

    
    const monthSelect = document.getElementById("monthSelect");
    const detailMonthSelect = document.getElementById("detailMonthSelect");
    const prevMonthBtn = document.getElementById("prevMonth");
    const nextMonthBtn = document.getElementById("nextMonth");

    function populateMonthSelects(){
      [monthSelect, detailMonthSelect].forEach(sel=>{
        sel.innerHTML = "";
        monthSeries.forEach(m=>{
          const opt = document.createElement("option");
          opt.value = m.key;
          opt.textContent = m.label;
          sel.appendChild(opt);
        });
      });
      if(currentMonthKey){
      monthSelect.value = currentMonthKey;
      detailMonthSelect.value = currentMonthKey;
      }
    }

    function computeMoMDelta(currentIndex, metric){
      const curr = monthSeries[currentIndex][metric];
      const prev = currentIndex > 0 ? monthSeries[currentIndex-1][metric] : null;
      if(prev === null || prev === 0) return { delta: 0, pct: 0, hasPrev:false };
      const delta = curr - prev;
      const pct = delta / prev;
      return { delta, pct, hasPrev:true };
    }

    function renderKPIs(){
      if(!currentMonthKey || !monthSeries.length){
        document.getElementById("kpis").innerHTML = `<div class="muted">No data available</div>`;
        return;
      }
      const idx = indexOfMonth(currentMonthKey);
      const m = monthSeries[idx];
      const { delta:tiDelta, pct:tiPct, hasPrev:hasPrevTI } = computeMoMDelta(idx, "tradingIncome");
      const { delta:oiDelta, pct:oiPct, hasPrev:hasPrevOI } = computeMoMDelta(idx, "otherIncome");
      const { delta:oeDelta, pct:oePct, hasPrev:hasPrevOE } = computeMoMDelta(idx, "operatingExpenses");
      const { delta:csDelta, pct:csPct, hasPrev:hasPrevCS } = computeMoMDelta(idx, "costOfSales");

      const kpis = [
        { label:"Trading Income", value: currency(m.tradingIncome), delta: hasPrevTI ? `${tiDelta>=0? "▲":"▼"} ${percent(tiPct)}` : "—", pos: tiDelta>=0 },
        { label:"Other Income", value: currency(m.otherIncome), delta: hasPrevOI ? `${oiDelta>=0? "▲":"▼"} ${percent(oiPct)}` : "—", pos: oiDelta>=0 },
        { label:"Operating Expenses", value: currency(m.operatingExpenses), delta: hasPrevOE ? `${oeDelta>=0? "▲":"▼"} ${percent(oePct)}` : "—", pos: oeDelta>=0 },
        { label:"Cost of Sales", value: currency(m.costOfSales), delta: hasPrevCS ? `${csDelta>=0? "▲":"▼"} ${percent(csPct)}` : "—", pos: csDelta>=0 },
      ];
      document.getElementById("kpis").innerHTML = kpis.map(k => `
        <div class="kpi">
          <div class="label">${k.label}</div>
          <div class="value">${k.value}</div>
          <div class="delta"><span class="${k.pos ? "up":"down"}">${k.delta}</span></div>
        </div>
      `).join("");
    }

    function renderTrendChart(){
      if(!currentMonthKey || !monthSeries.length) return;
      const ctx = document.getElementById("trendChart");
      const labels = monthSeries.map(m => m.label);
      const tradingIncome = monthSeries.map(m => m.tradingIncome);
      const otherIncome = monthSeries.map(m => m.otherIncome);
      const operatingExpenses = monthSeries.map(m => m.operatingExpenses);
      const costOfSales = monthSeries.map(m => m.costOfSales);
      if(trendChart){ trendChart.destroy(); }
      trendChart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "Trading Income",
              data: tradingIncome,
              borderColor: "#AD0BF6",
              backgroundColor: "rgba(173,11,246,.15)",
              tension: .35,
              fill: true,
              borderWidth: 2,
              pointRadius: 2.5,
            },
            {
              label: "Other Income",
              data: otherIncome,
              borderColor: "#ff4d8d",
              backgroundColor: "rgba(255,77,141,.15)",
              tension: .35,
              fill: true,
              borderWidth: 2,
              pointRadius: 2.5,
            },
            {
              label: "Operating Expenses",
              data: operatingExpenses,
              borderColor: "#f59e0b",
              backgroundColor: "rgba(245,158,11,.15)",
              tension: .35,
              fill: true,
              borderWidth: 2,
              pointRadius: 2.5,
            },
            {
              label: "Cost of Sales",
              data: costOfSales,
              borderColor: "#e11d48",
              backgroundColor: "rgba(225,29,72,.15)",
              tension: .35,
              fill: true,
              borderWidth: 2,
              pointRadius: 2.5,
            },
          ]
        },
        options: {
          responsive:true,
          maintainAspectRatio:false,
          scales: {
            y: {
              grid: { color: "rgba(173,11,246,.15)" },
              ticks: { color: "#ffffff", callback:(v)=>"$"+fmt.format(v) }
            },
            x: { grid: { display:false }, ticks:{ color:"#ffffff" } }
          },
          plugins:{
            legend:{ labels:{ color:"#ffffff" } },
            tooltip:{ callbacks:{ label:(ctx)=> `${ctx.dataset.label}: ${currency(ctx.parsed.y)}` } }
          }
        }
      });
      document.getElementById("trendSubtitle").textContent = "Across months " + monthSeries[0].label + " – " + monthSeries[monthSeries.length-1].label;
    }

    function renderMixChart(){
      if(!currentMonthKey || !monthSeries.length) return;
      const ctx = document.getElementById("mixChart");
      const m = findMonth(currentMonthKey);
      const totalExpenses = m.operatingExpenses + m.costOfSales;
      const opExpPct = totalExpenses > 0 ? (m.operatingExpenses / totalExpenses) * 100 : 0;
      const cosPct = totalExpenses > 0 ? (m.costOfSales / totalExpenses) * 100 : 0;
      
      const labels = [
        `Operating Expenses (${fmt2.format(opExpPct)}%)`, 
        `Cost of Sales (${fmt2.format(cosPct)}%)`
      ];
      const vals = [m.operatingExpenses, m.costOfSales];
      if(mixChart){ mixChart.destroy(); }
      mixChart = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels,
          datasets: [{
            data: vals,
            backgroundColor: ["#f59e0b","#e11d48"],
            borderColor: "transparent",
            borderWidth: 0,
          }]
        },
        options: {
          responsive:true,
          maintainAspectRatio:false,
          plugins:{ 
            legend:{ 
              labels:{ 
                color:"#ffffff"
              } 
            },
            tooltip:{ 
              callbacks:{ 
                label:(ctx)=> `${ctx.label}: ${currency(ctx.parsed)}` 
              } 
            }
          }
        }
      });
      document.getElementById("mixSubtitle").textContent = m.label;
    }

    function renderAnalysis(){
      if(!currentMonthKey || !monthSeries.length) { 
        document.getElementById("analysisText").textContent = "No data available for analysis."; 
        return; 
      }
      const idx = indexOfMonth(currentMonthKey);
      const m = monthSeries[idx];
      const prev = idx>0 ? monthSeries[idx-1] : null;
      const growthTI = prev ? (m.tradingIncome - prev.tradingIncome) / (prev.tradingIncome || 1) : 0;
      const growthOI = prev ? (m.otherIncome - prev.otherIncome) / (prev.otherIncome || 1) : 0;
      const growthOE = prev ? (m.operatingExpenses - prev.operatingExpenses) / (prev.operatingExpenses || 1) : 0;
      const growthCS = prev ? (m.costOfSales - prev.costOfSales) / (prev.costOfSales || 1) : 0;
      const accountRows = buildAccountRows(currentMonthKey);
      const topAccount = accountRows[0];
      const totalIncome = m.tradingIncome + m.otherIncome;
      const totalExpenses = m.operatingExpenses + m.costOfSales;

      const text = `
        ${m.label} performance: Trading Income ${currency(m.tradingIncome)} ${prev ? `(${growthTI>=0?"▲":"▼"} ${percent(growthTI)})` : ""}, Other Income ${currency(m.otherIncome)} ${prev ? `(${growthOI>=0?"▲":"▼"} ${percent(growthOI)})` : ""}. 
        Operating Expenses ${currency(m.operatingExpenses)} ${prev ? `(${growthOE>=0?"▲":"▼"} ${percent(growthOE)})` : ""}, Cost of Sales ${currency(m.costOfSales)} ${prev ? `(${growthCS>=0?"▲":"▼"} ${percent(growthCS)})` : ""}.
        Net profit ${currency(m.profit)} with ${percent(m.margin)} margin. 
        Top account: ${topAccount ? topAccount.account : "N/A"} (${topAccount ? currency(topAccount.value) : "N/A"}).
        Focus: Optimize cost structure while maintaining income growth momentum.
      `.replace(/\s+/g,' ').trim();
      document.getElementById("analysisText").textContent = text;
    }

    function updateExecutive(){
      populateMonthSelects();
      renderKPIs();
      renderTrendChart();
      renderMixChart();
      renderAnalysis();
    }

    prevMonthBtn.addEventListener("click", ()=>{
      if(!currentMonthKey) return;
      const idx = Math.max(0, indexOfMonth(currentMonthKey)-1);
      currentMonthKey = monthSeries[idx].key;
      monthSelect.value = currentMonthKey;
      detailMonthSelect.value = currentMonthKey;
      updateExecutive();
      updateDetail();
      pulse(document.querySelector("#kpis"));
    });
    nextMonthBtn.addEventListener("click", ()=>{
      if(!currentMonthKey) return;
      const idx = Math.min(monthSeries.length-1, indexOfMonth(currentMonthKey)+1);
      currentMonthKey = monthSeries[idx].key;
      monthSelect.value = currentMonthKey;
      detailMonthSelect.value = currentMonthKey;
      updateExecutive();
      updateDetail();
      pulse(document.querySelector("#kpis"));
    });
    monthSelect.addEventListener("change", (e)=>{
      currentMonthKey = e.target.value;
      detailMonthSelect.value = currentMonthKey;
      updateExecutive();
      updateDetail();
    });

    document.querySelector('[data-action="toggle-lines"]')?.addEventListener("click", ()=>{
      showProfitLine = !showProfitLine;
      renderTrendChart();
      pulse(document.getElementById("trendChart").parentElement.parentElement);
    });
    
    const sectionSelect = document.getElementById("sectionSelect");
    const searchInput = document.getElementById("searchInput");
    const resetFilters = document.getElementById("resetFilters");
    const detailTableBody = document.querySelector("#detailTable tbody");
    let detailSort = { key:"value", dir:"desc" };

    function populateSectionSelect(){
      const uniqueSections = Array.from(new Set(rows.map(r=>r.section)));
      sectionSelect.innerHTML = `<option value="all">All</option>` + uniqueSections.map(s=>`<option value="${s}">${s}</option>`).join("");
      sectionSelect.value = "all";
    }

    function filteredRows(){
      if(!currentMonthKey || !monthSeries.length) return [];
      const acctRows = buildAccountRows(detailMonthSelect.value || currentMonthKey);
      const sec = sectionSelect.value;
      const q = (searchInput.value || "").toLowerCase().trim();
      return acctRows.filter(r=>{
        const passSec = sec === "all" ? true : r.section === sec;
        const passQ = !q || r.account.toLowerCase().includes(q) || r.section.toLowerCase().includes(q);
        return passSec && passQ;
      });
    }

    function renderTable(){
      let rows = filteredRows();
      rows.sort((a,b)=>{
        const k = detailSort.key;
        const dir = detailSort.dir === "asc" ? 1 : -1;
        let va = a[k], vb = b[k];
        if(typeof va === "string"){ return va.localeCompare(vb) * dir; }
        return (va - vb) * dir;
      });
      detailTableBody.innerHTML = rows.map(r=>`
        <tr>
          <td>${r.account}</td>
          <td>${r.section}</td>
          <td>${currency(r.value)}</td>
        </tr>
      `).join("");
      document.getElementById("tableSubtitle").textContent =
        `${findMonth(detailMonthSelect.value).label} • ${rows.length} accounts`;
    }

    function renderBarChart(){
      if(!currentMonthKey || !monthSeries.length) return;
      const ctx = document.getElementById("barChart");
      const rows = filteredRows();
      const labels = rows.map(r=>r.account);
      const data = rows.map(r=>r.value);
      if(barChart){ barChart.destroy(); }
      barChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "Revenue",
            data,
            backgroundColor: "rgba(173,11,246,.55)",
            borderColor: "#AD0BF6",
            borderWidth: 1.5
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          scales:{
            y:{ grid:{ color:"rgba(173,11,246,.15)" }, ticks:{ color:"#ffffff", callback:(v)=>"$"+fmt.format(v)} },
            x:{ grid:{ display:false }, ticks:{ color:"#ffffff" } }
          },
          plugins:{ legend:{ labels:{ color:"#ffffff" } } }
        }
      });
      document.getElementById("barSubtitle").textContent = findMonth(detailMonthSelect.value).label;
    }

    function updateDetail(){
      renderTable();
      renderBarChart();
    }

    detailMonthSelect.addEventListener("change",(e)=>{
      currentMonthKey = e.target.value;
      monthSelect.value = currentMonthKey;
      updateExecutive();
      updateDetail();
    });
    sectionSelect.addEventListener("change", updateDetail);
    searchInput.addEventListener("input", updateDetail);
    resetFilters.addEventListener("click", ()=>{
      sectionSelect.value = "all";
      searchInput.value = "";
      updateDetail();
    });
    document.querySelectorAll("#detailTable thead th").forEach(th=>{
      th.addEventListener("click", ()=>{
        const key = th.dataset.sort;
        if(detailSort.key === key){
          detailSort.dir = detailSort.dir === "asc" ? "desc" : "asc";
        } else {
          detailSort.key = key;
          detailSort.dir = "asc";
        }
        renderTable();
      });
    });

   
    const chatLog = document.getElementById("chatLog");
    const chatInput = document.getElementById("chatInput");
    const sendBtn = document.getElementById("sendBtn");

    function addMsg(text, who="bot"){
      const systemMessages = [
        "Workflow running",
      ];
      
      if (systemMessages.some(msg => text.includes(msg))) {
        return; 
      }
      
      const row = document.createElement("div");
      row.className = `msg ${who}`;
      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.innerHTML = text;
      row.appendChild(bubble);
      chatLog.appendChild(row);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    function normalizeMonthToken(s){
      const token = s.toLowerCase();
      const mIndex = {jan:1,january:1,feb:2,february:2,mar:3,march:3,apr:4,april:4,may:5,jun:6,june:6,jul:7,july:7,aug:8,august:8,sep:9,september:9,oct:10,october:10,nov:11,november:11,dec:12,december:12}[token];
      if(!mIndex) return undefined;
      const candidates = monthSeries.filter(ms => Number(ms.key.split('-')[1]) === mIndex);
      if(candidates.length === 0) return undefined;
      return candidates[candidates.length-1].key; 
    }

    function intentFromText(q){
      const t = q.toLowerCase();
      const monthTokens = Array.from(t.matchAll(/\b(20\d{2}-(0[1-9]|1[0-2])|jan(?:uary)?|feb(?:ruary)?|mar(?:ch)?|apr(?:il)?|may|jun(?:e)?|jul(?:y)?|aug(?:ust)?|sep(?:tember)?|oct(?:ober)?|nov(?:ember)?|dec(?:ember)?)\b/g)).map(m=>m[0]);
      const monthsNorm = monthTokens.map(m => /^20\d{2}-/.test(m) ? m : normalizeMonthToken(m)).filter(Boolean);

      const intents = {
        setMonth: /\b(set|change|switch)\b.*\bmonth\b/.test(t) && monthsNorm[0],
        compare: /\bcompare|vs\b/.test(t) && (monthsNorm[0] || currentMonthKey) && monthsNorm[1],
        askTradingIncome: /\b(trading income|trading revenue)\b/.test(t),
        askOtherIncome: /\b(other income|other revenue)\b/.test(t),
        askOperatingExpenses: /\b(operating expenses|operating costs)\b/.test(t),
        askCostOfSales: /\b(cost of sales|cogs)\b/.test(t),
        askProfit: /\bprofit\b/.test(t),
        askMargin: /\bmargin\b/.test(t),
        askGrowth: /\bgrowth|change|delta\b/.test(t),
        topAccount: /\btop (account|line)\b/.test(t),
        topSection: /\btop section\b/.test(t),
        openDetail: /\b(detail|table)\b/.test(t),
        openExec: /\b(executive|summary)\b/.test(t),
        breakdownProduct: /\b(account breakdown|by account)\b/.test(t),
      };
      return { monthsNorm, intents };
    }

    function pulse(el){ if(!el) return; el.classList.add("pulse"); setTimeout(()=>el.classList.remove("pulse"), 1500); }

    function handleQuery(q){
      addMsg(q, "user");
      const { monthsNorm, intents } = intentFromText(q);

      if(intents.setMonth){
        currentMonthKey = intents.setMonth;
        monthSelect.value = currentMonthKey;
        detailMonthSelect.value = currentMonthKey;
        updateExecutive(); updateDetail();
        addMsg(`Month set to <b>${findMonth(currentMonthKey).label}</b>.`);
        pulse(document.getElementById("kpis"));
        return;
      }
      if(intents.breakdownProduct){
        addMsg("Showing <b>Value by Account</b> for the selected month below.");
        pulse(document.getElementById("barChart").parentElement.parentElement);
        return;
      }

      const monthKey = monthsNorm[0] || currentMonthKey;
      const idx = indexOfMonth(monthKey);
      const m = findMonth(monthKey);
       if(!m){ addMsg("Load data first, then ask questions."); return; }

      if(intents.compare && monthsNorm.length >= 2){
        const a = findMonth(monthsNorm[0]); const b = findMonth(monthsNorm[1]);
        if(a && b){
          const diffTI = b.tradingIncome - a.tradingIncome;
          const pctTI = a.tradingIncome ? diffTI / a.tradingIncome : 0;
          const diffOI = b.otherIncome - a.otherIncome;
          const pctOI = a.otherIncome ? diffOI / a.otherIncome : 0;
          addMsg(`<b>${b.label}</b> vs <b>${a.label}</b>: Trading Income ${currency(b.tradingIncome)} vs ${currency(a.tradingIncome)} (${diffTI>=0?"▲":"▼"} ${percent(pctTI)}), Other Income ${currency(b.otherIncome)} vs ${currency(a.otherIncome)} (${diffOI>=0?"▲":"▼"} ${percent(pctOI)}).`);
          pulse(document.getElementById("trendChart").parentElement.parentElement);
        } else {
          addMsg("Please specify two valid months to compare.");
        }
        return;
      }

      if(intents.askTradingIncome){
        addMsg(`<b>${m.label}</b> Trading Income: <b>${currency(m.tradingIncome)}</b>.`);
        pulse(document.getElementById("kpis"));
        return;
      }
      if(intents.askOtherIncome){
        addMsg(`<b>${m.label}</b> Other Income: <b>${currency(m.otherIncome)}</b>.`);
        pulse(document.getElementById("kpis"));
        return;
      }
      if(intents.askOperatingExpenses){
        addMsg(`<b>${m.label}</b> Operating Expenses: <b>${currency(m.operatingExpenses)}</b>.`);
        pulse(document.getElementById("kpis"));
        return;
      }
      if(intents.askCostOfSales){
        addMsg(`<b>${m.label}</b> Cost of Sales: <b>${currency(m.costOfSales)}</b>.`);
        pulse(document.getElementById("kpis"));
        return;
      }
      if(intents.askProfit){
        addMsg(`<b>${m.label}</b> profit: <b>${currency(m.profit)}</b>.`);
        pulse(document.getElementById("kpis"));
        return;
      }
      if(intents.askMargin){
        addMsg(`<b>${m.label}</b> margin: <b>${percent(m.margin)}</b>.`);
        pulse(document.getElementById("kpis"));
        return;
      }
      if(intents.askGrowth){
        const gTI = computeMoMDelta(idx, "tradingIncome");
        const gOI = computeMoMDelta(idx, "otherIncome");
        if(!gTI.hasPrev && !gOI.hasPrev){ addMsg("No prior month to compare."); return; }
        let msg = "Growth vs prior month: ";
        if(gTI.hasPrev) msg += `Trading Income ${gTI.delta>=0?"▲":"▼"} <b>${percent(gTI.pct)}</b> (${gTI.delta>=0?"+":""}${currency(gTI.delta)}), `;
        if(gOI.hasPrev) msg += `Other Income ${gOI.delta>=0?"▲":"▼"} <b>${percent(gOI.pct)}</b> (${gOI.delta>=0?"+":""}${currency(gOI.delta)}).`;
        addMsg(msg);
        pulse(document.getElementById("trendChart").parentElement.parentElement);
        return;
      }
      if(intents.topAccount){
        const rows = buildAccountRows(monthKey);
        addMsg(`Top account in <b>${m.label}</b>: <b>${rows[0].account}</b> (${currency(rows[0].value)} in ${rows[0].section}).`);
        pulse(document.getElementById("barChart").parentElement.parentElement);
        return;
      }
      if(intents.topSection){
        const mix = sectionMixForMonth(monthKey).sort((a,b)=>b.pct-a.pct)[0];
        addMsg(`Top section in <b>${m.label}</b>: <b>${mix.key}</b> (${percent(mix.pct)} of activity).`);
        pulse(document.getElementById("mixChart").parentElement.parentElement);
        return;
      }

      addMsg("I can help with totals, profit, margin, month changes, comparisons, top product/category, and navigation to views.");
    }

    document.querySelectorAll(".chip.q").forEach(chip=>{
      chip.addEventListener("click", async ()=>{
        const question = chip.textContent;
        
        addMsg(question, "user");
        
        try {
          const response = await fetch('https://opsteamai.app.n8n.cloud/webhook-test/8e785180-6a96-41eb-95dd-606aaf85b75b', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              message: question,
              timestamp: new Date().toISOString(),
              userInput: question,
              type: 'predefined_question'
            })
          });
          
          if (response.ok) {
            try {
              const aiResponse = await response.json();
              
              console.log('Raw AI response from n8n:', aiResponse);
              console.log('Response type:', typeof aiResponse);
              console.log('Response keys:', Object.keys(aiResponse || {}));
              
              const parsedResponse = parseAIResponse(aiResponse);
              addMsg(parsedResponse, "bot");
            } catch (parseError) {
              console.error('Error parsing AI response:', parseError);
              try {
                const textResponse = await response.text();
                console.log('Raw text response from n8n:', textResponse);
                addMsg(textResponse || "AI response received but could not be parsed.", "bot");
              } catch (textError) {
                addMsg("AI response received but could not be parsed.", "bot");
              }
            }
          } else {
            console.error('Webhook response error:', {
              status: response.status,
              statusText: response.statusText,
              url: response.url
            });
            
            if (response.status === 404) {
              addMsg("Error 404: Webhook endpoint not found. Please check the webhook URL.", "bot");
            } else if (response.status === 500) {
              addMsg("Error 500: Server error in the workflow. Please try again later.", "bot");
            } else if (response.status === 403) {
              addMsg("Error 403: Access denied to the workflow. Please check permissions.", "bot");
            } else {
              addMsg(`Error ${response.status}: ${response.statusText}. Please try again.`, "bot");
            }
          }
        } catch (error) {
          console.error('Error sending to webhook:', error);
          addMsg("Error connecting to workflow. Please try again.", "bot");
        }
        
      });
    });
    sendBtn.addEventListener("click", async ()=>{
      const q = chatInput.value.trim();
      if(!q) return;
      
      const originalText = sendBtn.textContent;
      sendBtn.textContent = "Sending...";
      sendBtn.disabled = true;
      
      addMsg(q, "user");
      
              try {
          const timeoutPromise = new Promise((_, reject) => {
            setTimeout(() => reject(new Error('Request timeout after 30 seconds')), 160000);
          });
          
          const fetchPromise = fetch('https://opsteamai.app.n8n.cloud/webhook-test/8e785180-6a96-41eb-95dd-606aaf85b75b', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              message: q,
              timestamp: new Date().toISOString(),
              userInput: q
            })
          });
          
          const response = await Promise.race([fetchPromise, timeoutPromise]);
        
        if (response.ok) {
                      try {
              const aiResponse = await response.json();
              
              console.log('Raw AI response from n8n:', aiResponse);
              console.log('Response type:', typeof aiResponse);
              console.log('Response keys:', Object.keys(aiResponse || {}));
              
              const parsedResponse = parseAIResponse(aiResponse);
              addMsg(parsedResponse, "bot");
            } catch (parseError) {
              console.error('Error parsing AI response:', parseError);
              try {
                const textResponse = await response.text();
                console.log('Raw text response from n8n:', textResponse);
                addMsg(textResponse || "AI response received but could not be parsed.", "bot");
              } catch (textError) {
                addMsg("AI response received but could not be parsed.", "bot");
              }
            }
        } else {
          console.error('Webhook response error:', {
            status: response.status,
            statusText: response.statusText,
            url: response.url
          });
          
          if (response.status === 404) {
            addMsg("Error 404: Webhook endpoint not found. Please check the webhook URL.", "bot");
          } else if (response.status === 500) {
            addMsg("Error 500: Server error in the workflow. Please try again later.", "bot");
          } else if (response.status === 403) {
            addMsg("Error 403: Access denied to the workflow. Please check permissions.", "bot");
          } else {
            addMsg(`Error ${response.status}: ${response.statusText}. Please try again.`, "bot");
          }
        }
              } catch (error) {
          console.error('Error sending to webhook:', error);
          console.error('Error details:', {
            name: error.name,
            message: error.message,
            stack: error.stack
          });
          
          if (error.name === 'TypeError' && error.message.includes('fetch')) {
            addMsg("Network error: Unable to connect to the workflow. Please check your internet connection.", "bot");
          } else if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
            addMsg("Connection failed: The workflow server may be down or unreachable.", "bot");
          } else {
            addMsg(`Error: ${error.message || 'Unknown error occurred'}. Please try again.`, "bot");
          }
        } finally {
          sendBtn.textContent = originalText;
          sendBtn.disabled = false;
        }
        
        chatInput.value = "";
    });
    chatInput.addEventListener("keydown", (e)=>{
      if(e.key==="Enter" && !e.shiftKey){
        e.preventDefault();
        sendBtn.click();
      }
    });    
    function parseCSV(text){
      const cleaned = text.replace(/^\uFEFF/, "");
      const firstLine = (cleaned.split(/\r?\n/)[0] || '');
      const commaCount = (firstLine.match(/,/g) || []).length;
      const semicolonCount = (firstLine.match(/;/g) || []).length;
      const tabCount = (firstLine.match(/\t/g) || []).length;
      const delim = commaCount>=semicolonCount && commaCount>=tabCount ? ',' : (semicolonCount>=tabCount ? ';' : '\t');

      const lines = cleaned.replace(/\r\n?/g, "\n").split("\n").filter(l => l.length > 0);
      if(lines.length === 0) return [];

      const headerLine = lines.shift();
      const headerCells = [];
      { let cur=''; let inQ=false; for(let i=0;i<headerLine.length;i++){ const ch=headerLine[i]; if(ch==='"'){ if(inQ && headerLine[i+1]==='"'){ cur+='"'; i++; } else { inQ=!inQ; } } else if(ch===delim && !inQ){ headerCells.push(cur); cur=''; } else { cur+=ch; } } headerCells.push(cur); }

      const normalize = (s)=> String(s||'').trim().toLowerCase().replace(/[\s_\-]/g,'');
      const headerNorm = headerCells.map(normalize);
      window.__lastCsvHeader = headerCells; window.__lastCsvDelimiter = delim;

      const findIdx = (candidates)=>{
        const options = candidates.map(normalize);
        for(const opt of options){
          const i = headerNorm.indexOf(opt);
          if(i !== -1) return i;
        }
        return -1;
      };

      const monthFrom = (m)=>{
        const raw = String(m||'').trim();
        if(raw === '') return undefined;
        const num = Number(raw.replace(/[^0-9.-]/g, ''));
        if(!isNaN(num) && num>=1 && num<=12) return num;
        const short = raw.slice(0,3).toLowerCase();
        const map = {jan:1,feb:2,mar:3,apr:4,may:5,jun:6,jul:7,aug:8,sep:9,oct:10,nov:11,dec:12};
        return map[short];
      };
      const numFrom = (v)=>{ if(v==null) return 0; const s = String(v).replace(/[$,\s]/g,'').replace(/[()]/g, m=> m==='(' ? '-' : ''); const n = Number(s); return isNaN(n)?0:n; };

      const idxFY = findIdx(['financial year','financialyear','fy']);
      const idxQ  = findIdx(['quarter','qtr']);
      const idxCY = findIdx(['calendar year','calendaryear','year']);
      const idxM  = findIdx(['month']);
      const idxMN = findIdx(['month number','month num','monthnum','monthno']);
      const idxVal= findIdx(['value','amount','total']);
      const idxSec= findIdx(['section','type','category']);
      const idxAcc= findIdx(['account','account name','name','glaccount']);

      const out = [];
      for(const line of lines){
        const cells = [];
        let cur = ''; let inQ=false; for(let i=0;i<line.length;i++){
          const ch = line[i];
          if(ch==='"'){ if(inQ && line[i+1]==='"'){ cur+='"'; i++; } else { inQ=!inQ; } }
          else if(ch===delim && !inQ){ cells.push(cur); cur=''; }
          else { cur+=ch; }
        }
        cells.push(cur);
        const rec = {
          financialYear: idxFY>=0 ? (cells[idxFY]||'').trim() : '',
          quarter:       idxQ>=0  ? (cells[idxQ]||'').trim()  : '',
          calendarYear:  idxCY>=0 ? Number(String(cells[idxCY]||'').replace(/[^0-9-]/g,'')) : undefined,
          month:         idxM>=0  ? (cells[idxM]||'').trim()  : '',
          monthNum:      monthFrom(idxMN>=0 ? cells[idxMN] : (idxM>=0 ? cells[idxM] : '')),
          value:         numFrom(idxVal>=0 ? cells[idxVal] : 0),
          section:       idxSec>=0? (cells[idxSec]||'').trim() : '',
          account:       idxAcc>=0? (cells[idxAcc]||'').trim() : '',
        };
        if(rec.calendarYear && rec.monthNum){ out.push(rec); }
      }
      return out;
    }

    document.getElementById('openWorkflowBtn').addEventListener('click', async ()=>{
      console.log('Data Refresh button clicked!');
      console.log('Button element:', document.getElementById('openWorkflowBtn'));
      console.log('Button data-url:', document.getElementById('openWorkflowBtn')?.getAttribute('data-url'));
      
      const button = document.getElementById('openWorkflowBtn');
      const originalText = button.textContent;
      button.textContent = 'Refreshing...';
      button.disabled = true;
      
      try {
        await fetchFromN8n();
      } finally {
        button.textContent = originalText;
        button.disabled = false;
      }
    });
    document.getElementById('csvInput').addEventListener('change', async (e)=>{
      const file = e.target.files?.[0]; if(!file) return;
      const text = await file.text();
      try{
        const imported = parseCSV(text);
        if(imported.length === 0){ 
          return; 
        }
        rows = imported;
        monthSeries = computeMonthSeries(rows);
        currentMonthKey = monthSeries.length ? monthSeries[monthSeries.length-1].key : null;
        updateExecutive();
        populateSectionSelect();
        updateDetail();
      } catch(err){
        console.error(err);
      } finally {
        e.target.value = '';
      }
    });

    window.loadDashboardData = function(rowsArray){
      console.log('loadDashboardData function called with:', rowsArray);
      if(!Array.isArray(rowsArray)) {
        console.error('loadDashboardData: rowsArray is not an array:', rowsArray);
        return;
      }
      console.log('Processing', rowsArray.length, 'rows');
      
      rows = rowsArray.map(r=>({
        financialYear: r['Financial Year'] ?? r.financialYear,
        quarter: r['Quarter'] ?? r.quarter,
        calendarYear: Number(r['Calendar Year'] ?? r.calendarYear),
        month: r['Month'] ?? r.month,
        monthNum: Number(r['Month Number'] ?? r.monthNum ?? r['Month Num']),
        value: Number(String(r['Value'] ?? r.value).replace(/[$,\s]/g,''))||0,
        section: r['Section'] ?? r.section,
        account: r['Account'] ?? r.account,
      })).filter(r=>r.calendarYear && r.monthNum);
      
      console.log('Processed rows:', rows.length);
      monthSeries = computeMonthSeries(rows);
      currentMonthKey = monthSeries.length ? monthSeries[monthSeries.length-1].key : null;
      updateExecutive();
      populateSectionSelect();
      updateDetail();
      console.log('Dashboard updated successfully');
    }
    
    console.log('loadDashboardData function defined:', typeof window.loadDashboardData);

    async function fetchFromN8n(){
      console.log('fetchFromN8n function called');
      const url = document.getElementById('openWorkflowBtn')?.getAttribute('data-url');
      console.log('Webhook URL:', url);
      
      if(!url){ 
        console.warn('No webhook URL configured for Data Refresh button');
        alert('No webhook URL configured. Please check the button configuration.');
        return; 
      }
      
      try{
        console.log('Fetching data from n8n workflow:', url);
        const res = await fetch(url, { method: 'GET', headers: { 'Accept': 'application/json,text/plain;q=0.9,*/*;q=0.8' } });
        console.log('Response status:', res.status);
        console.log('Response headers:', res.headers);
        
        const ct = res.headers.get('content-type') || '';
        const raw = ct.includes('application/json') ? await res.json().catch(()=>null) : await res.text().catch(()=>null);
        console.log('Raw response:', raw);
        
        const data = typeof raw === 'string' ? (raw ? JSON.parse(raw) : null) : raw;
        if(!data){ 
          console.warn('Workflow returned no JSON data');
          alert('Workflow returned no data. Please check the n8n workflow configuration.');
          return; 
        }
        
        let incomingRows = null;
        if(Array.isArray(data)){
          incomingRows = data.map(x => (x && typeof x === 'object' && 'json' in x) ? x.json : x);
        } else if(Array.isArray(data.rows)){
          incomingRows = data.rows;
        } else if(Array.isArray(data.data)){
          incomingRows = data.data;
        }
        
        if(!incomingRows){
          console.warn('Unexpected payload format:', data);
          alert('Unexpected data format from workflow. Please check the n8n workflow output.');
          return;
        }
        
        console.log('Successfully fetched data from n8n:', incomingRows.length, 'rows');
        
        if (typeof window.loadDashboardData === 'function') {
          window.loadDashboardData(incomingRows);
          alert(`Successfully refreshed data! Loaded ${incomingRows.length} rows.`);
        } else {
          console.error('loadDashboardData function not found');
          try {
            rows = incomingRows.map(r=>({
              financialYear: r['Financial Year'] ?? r.financialYear,
              quarter: r['Quarter'] ?? r.quarter,
              calendarYear: Number(r['Calendar Year'] ?? r.calendarYear),
              month: r['Month'] ?? r.month,
              monthNum: Number(r['Month Number'] ?? r.monthNum ?? r['Month Num']),
              value: Number(String(r['Value'] ?? r.value).replace(/[$,\s]/g,''))||0,
              section: r['Section'] ?? r.section,
              account: r['Account'] ?? r.account,
            })).filter(r=>r.calendarYear && r.monthNum);
            monthSeries = computeMonthSeries(rows);
            currentMonthKey = monthSeries.length ? monthSeries[monthSeries.length-1].key : null;
            updateExecutive();
            populateSectionSelect();
            updateDetail();
            
          } catch (fallbackError) {
            console.error('Fallback method also failed:', fallbackError);
            alert('Error: Could not load dashboard data. Please refresh the page and try again.');
          }
        }
        
      } catch (e){
        console.error('Error fetching from n8n workflow:', e);
        alert(`Error: ${e.message}`);
      }
    }
    
    // Tab switching functionality
    function switchTab(targetTab) {
      console.log('switchTab called with:', targetTab);
      
      // Update button states
      const tabButtons = document.querySelectorAll('.tab-btn');
      tabButtons.forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-tab') === targetTab) {
          btn.classList.add('active');
        }
      });
      
      // Update section visibility
      const tabSections = document.querySelectorAll('.tab');
      tabSections.forEach(section => {
        section.style.display = 'none';
      });
      
      const targetSection = document.getElementById(`tab-${targetTab}`);
      console.log('Target section:', targetSection);
      if (targetSection) {
        targetSection.style.display = 'block';
        console.log('Tab switched to:', targetTab);
      } else {
        console.error('Target section not found for tab:', targetTab);
      }
    }
    
    function setupTabs() {
      console.log('Setting up tab switching...');
      const tabButtons = document.querySelectorAll('.tab-btn');
      const tabSections = document.querySelectorAll('.tab');
      
      console.log('Found tab buttons:', tabButtons.length);
      console.log('Found tab sections:', tabSections.length);
      
      tabButtons.forEach(button => {
        button.addEventListener('click', function(e) {
          e.preventDefault();
          const targetTab = this.getAttribute('data-tab');
          console.log('Tab clicked:', targetTab);
          
          // Update button states
          tabButtons.forEach(btn => btn.classList.remove('active'));
          this.classList.add('active');
          
          // Update section visibility
          tabSections.forEach(section => {
            section.style.display = 'none';
          });
          
          const targetSection = document.getElementById(`tab-${targetTab}`);
          console.log('Target section:', targetSection);
          if (targetSection) {
            targetSection.style.display = 'block';
            console.log('Tab switched to:', targetTab);
          } else {
            console.error('Target section not found for tab:', targetTab);
          }
        });
      });
    }
    
    // Try to set up tabs when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setupTabs);
    } else {
      setupTabs();
    }
    
    function init(){
      monthSeries = computeMonthSeries(rows);
      currentMonthKey = monthSeries.length ? monthSeries[monthSeries.length - 1].key : null;
      updateExecutive();
      populateSectionSelect();
      updateDetail();
      console.log('Init complete. loadDashboardData function available:', typeof window.loadDashboardData === 'function');
    }
    init();
  </script>
</body>
</html>